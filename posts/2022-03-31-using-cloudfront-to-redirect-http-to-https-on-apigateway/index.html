<!DOCTYPE html>
<html lang="en" data-theme="fantasy">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Tyler Hall - Fullstack Web Developer</title>
    <base href="/">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tyler Hall - Web Developer, hyper Core team, Open Source Project Maintainer">
    <meta name="keywords" content="Tyler Hall, Blog, JavaScript, Hyper, GraphQL, Deno, Svelte, React, ADT, Functional">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/theme-change@2.0.2/index.js"></script>  
  <link rel="stylesheet" href="/assets/asset.bbd1a9b4.css"></link>
</head>

  <body>
    <div class="navbar bg-base-100">
  <div class="flex-1">
    <div class="flex justify-center space-around py-2 space-x-4">
      <a href="/" class="font-bold">Tyler Hall</a>
    </div>
  </div>
  <div class="flex-none">
    <ul class="menu menu-horizontal p-0 space-around space-x-4">
      <li>
        <a role="button" href="/about" title="About Me" class="">
  
          About
        
</a>
      </li>
      <div title="Change Theme" class="dropdown dropdown-end">
  <div tabindex="0" class="btn gap-2 normal-case btn-ghost">
    <!-- Swatch -->
    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block h-5 w-5 stroke-current md:h-6 md:w-6">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01">
      </path>
    </svg>
    <span class="hidden md:inline">Change Theme</span>
    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792" class="ml-1 inline-block h-4 w-4 fill-current">
      <path d="M1395 736q0 13-10 23l-466 466q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l50-50q10-10 23-10t23 10l393 393 393-393q10-10 23-10t23 10l50 50q10 10 10 23z">
      </path>
    </svg>
  </div>
  <div class="dropdown-content bg-base-200 text-base-content rounded-t-box rounded-b-box top-px h-96 w-52 overflow-y-auto shadow-2xl mt-16">
    <ul class="menu menu-compact p-4" tabindex="0">
      <li><button data-set-theme="fantasy" data-act-class="active" class="active">ğŸ§šâ€â™€ï¸ â€‡fantasy</button></li>
      <li><button data-set-theme="black" data-act-class="active">ğŸ´ â€‡black</button></li>
      <li><button data-set-theme="lisght" data-act-class="active">ğŸŒ â€‡light</button></li>
      <li><button data-set-theme="dark" data-act-class="active">ğŸŒš â€‡dark</button></li>
      <li><button data-set-theme="cupcake" data-act-class="active" class="">ğŸ§ â€‡cupcake</button></li>
      <li><button data-set-theme="bumblebee" data-act-class="active" class="">ğŸ â€‡bumblebee</button></li>
      <li><button data-set-theme="emerald" data-act-class="active" class="">âœ³ï¸ â€‡Emerald</button></li>
      <li><button data-set-theme="corporate" data-act-class="active" class="">ğŸ¢ â€‡Corporate</button></li>
      <li><button data-set-theme="synthwave" data-act-class="active">ğŸŒƒ â€‡synthwave</button></li>
      <li><button data-set-theme="retro" data-act-class="active" class="">ğŸ‘´ â€‡retro</button></li>
      <li><button data-set-theme="cyberpunk" data-act-class="active" class="">ğŸ¤– â€‡cyberpunk</button></li>
      <li><button data-set-theme="valentine" data-act-class="active" class="">ğŸŒ¸ â€‡valentine</button></li>
      <li><button data-set-theme="halloween" data-act-class="active" class="">ğŸƒ â€‡halloween</button></li>
      <li><button data-set-theme="garden" data-act-class="active">ğŸŒ· â€‡garden</button></li>
      <li><button data-set-theme="forest" data-act-class="active">ğŸŒ² â€‡forest</button></li>
      <li><button data-set-theme="aqua" data-act-class="active">ğŸŸ â€‡aqua</button></li>
      <li><button data-set-theme="lofi" data-act-class="active">ğŸ‘“ â€‡lofi</button></li>
      <li><button data-set-theme="pastel" data-act-class="active">ğŸ– â€‡pastel</button></li>
      <li><button data-set-theme="wireframe" data-act-class="active">ğŸ“ â€‡Wireframe</button></li>
      <li><button data-set-theme="luxury" data-act-class="active">ğŸ’ â€‡luxury</button></li>
      <li><button data-set-theme="dracula" data-act-class="active">ğŸ§›â€â™‚ï¸ â€‡dracula</button></li>
      <li><button data-set-theme="cmyk" data-act-class="active">ğŸ–¨ â€‡CMYK</button></li>
      <li><button data-set-theme="autumn" data-act-class="active">ğŸ â€‡Autumn</button></li>
      <li><button data-set-theme="business" data-act-class="active">ğŸ’¼ â€‡Business</button></li>
      <li><button data-set-theme="acid" data-act-class="active">ğŸ’Š â€‡Acid</button></li>
      <li><button data-set-theme="lemonade" data-act-class="active">ğŸ‹ â€‡Lemonade</button></li>
      <li><button data-set-theme="night" data-act-class="active">ğŸŒ™ â€‡Night</button></li>
      <li><button data-set-theme="coffee" data-act-class="active">â˜•ï¸ â€‡Coffee</button></li>
      <li><button data-set-theme="winter" data-act-class="active">â„ï¸ â€‡Winter</button></li>
    </ul>
  </div>
</div>

      <li>
        <div>
          <a href="https://github.com/TillaTheHun0" title="GitHub">
            <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="inline-block h-5 w-5 fill-current md:h-6 md:w-6">
              <path d="M256,32C132.3,32,32,134.9,32,261.7c0,101.5,64.2,187.5,153.2,217.9a17.56,17.56,0,0,0,3.8.4c8.3,0,11.5-6.1,11.5-11.4,0-5.5-.2-19.9-.3-39.1a102.4,102.4,0,0,1-22.6,2.7c-43.1,0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1,1.4-14.1h.1c22.5,2,34.3,23.8,34.3,23.8,11.2,19.6,26.2,25.1,39.6,25.1a63,63,0,0,0,25.6-6c2-14.8,7.8-24.9,14.2-30.7-49.7-5.8-102-25.5-102-113.5,0-25.1,8.7-45.6,23-61.6-2.3-5.8-10-29.2,2.2-60.8a18.64,18.64,0,0,1,5-.5c8.1,0,26.4,3.1,56.6,24.1a208.21,208.21,0,0,1,112.2,0c30.2-21,48.5-24.1,56.6-24.1a18.64,18.64,0,0,1,5,.5c12.2,31.6,4.5,55,2.2,60.8,14.3,16.1,23,36.6,23,61.6,0,88.2-52.4,107.6-102.3,113.3,8,7.1,15.2,21.1,15.2,42.5,0,30.7-.3,55.5-.3,63,0,5.4,3.1,11.5,11.4,11.5a19.35,19.35,0,0,0,4-.4C415.9,449.2,480,363.1,480,261.7,480,134.9,379.7,32,256,32Z"></path>
            </svg>
          </a>
        </div>
      </li>
    </ul>
  </div>
</div>
      <main class="flex flex-grow justify-center min-h-screen p-4 mx-auto w-screen max-w-4xl">
        <div class="flex flex-grow justify-center min-h-screen">
    <article class="w-screen max-w-4xl p-8">
      <h1 class="text-primary text-2xl">Using CloudFront to Redirect HTTP -&gt; HTTPS on ApiGateway</h1>

      <span class="font-light text-sm bg-accent text-accent-content my-2">
        March 31, 2022 - 4 min read
      </span>

      <div class="divider"></div>

      <p>ApiGateway is great service for quickly spinning up a resilient, performant API layer for your application.</p><p>An increasingly common practice, as a result of putting frameworks like <a href="https://nextjs.org/">NextJS</a>, <a href="https://kit.svelte.dev/">SvelteKit</a>, and <a href="https://arc.codes/docs/en/get-started/quickstart">Architect</a> behind ApiGateway on a Lambda integration, is to serve static assets, as well as data, using a single ApiGateway. The ApiGateway is assigned a Custom Domain name, and serves the web applciation, assets, and the api the serves the data to power it.</p><h2 id="the-problem">The Problem</h2><p>When typing a url into a browser, if the protocol is not specified, most browsers will default to <code>http</code>. If your site is served up via ApiGateway, this will result in a failure to connect and an error:</p><p><img src="https://blog.hyper.io/content/images/2022/03/Screen-Shot-2022-03-31-at-5.55.12-PM.png" alt="This site can't be reached"></p><p>This is because ApiGateway only supports <code>https</code>. This isnâ€™t a great user experience. Instead of an error, it would be great to redirect <code>http</code> -> <code>https</code>.Unfortunately, this involves more moving parts than is expected. There isnâ€™t a setting that you can toggle in ApiGateway; <code>http</code> isnâ€™t supported. To get around this, most solutions use CloudFront to perform this redirect. There were some tutorials that already exist on how to do this, but all them were missing some key details. This post will describe how I used CloudFront in front of ApiGateway to redirect <code>http</code> to <code>https</code>.</p><h2 id="set-up-cloudfront">Set up CloudFront</h2><p>In order to set up CloudFront to redirect <code>http</code> to <code>https</code>, you will need to set up a CloudFront distribution to:</p><ol>
<li>redirect http -> https</li>
<li>forward all traffic to the <strong>invoke url</strong> of your ApiGateway</li>
</ol><p>There some quirks to this, that I will get into later in this post</p><p>First, navigate to the ApiGateway dashboard and take note of the invoke url for your Gateway.</p><p>Next, navigate to the CloudFront dashboard and create a new CloudFront Distribution.</p><p>For <strong>Origin Domain</strong> paste in your ApiGatewayâ€™s invoke URL.</p><p>For <strong>Origin Path</strong> if you are using your <strong>default</strong> stage, leave blank.</p><p>For <strong>Name</strong>, name the origin whatever youâ€™d like.</p><p>Under <strong>Viewer Protocol Policy</strong>, check <strong>Redirect HTTP to HTTPS</strong></p><p>Under <strong>Allowed HTTP Methods</strong>, check <strong>GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE</strong></p><p><strong>This Next Piece is Important!</strong></p><p>Scroll down to <strong>Cache key and origin requests</strong></p><p>Under <strong>Cache Policy</strong> choose <strong>CachingDisabled</strong> policy. This will prevent CloudFront from caching responses from your ApiGateway.</p><p>Under <strong>Origin request policy</strong> choose <strong>AllViewer</strong> policy. This will make CloudFront forward all headers it receives from the request to your ApiGateway. <strong>You will need this if your application uses cookies or Authorization header for AuthN/Z</strong>.</p><p><strong>If your ApiGateway uses a custom domain, this next piece is important!</strong></p><p>Scroll down to <strong>Settings</strong></p><p>Under <strong>Alternate domain name (CNAME)</strong> add the custom domain that is currently assigned to your ApiGateway. If youâ€™re using ACM, choose the corresponding certificate for that custom domain.</p><p>By default, ApiGateway has CORS disabled. If CORS is disabled on your ApiGateway, <strong>DO NOT</strong> remove the custom domain configuration from your ApiGateway. The custom domain configuration <strong>should match</strong> between CloudFront and ApiGateway. This will ensure requests are not rejected by ApiGateway due to CORS.</p><p>Create the Distribution. After a few minutes, your Distribution should be <strong>deployed</strong>.</p><p>Copy your <strong>Distribution domain name</strong>, and update your DNS, that currently resolves to your ApiGateway, to instead resolve to your Distributionâ€™s domain name. It may take some time for DNS to propagate.</p><p>This should be all you need to set up CloudFront in front of your ApiGateway, in order to redirect <code>http</code> -> <code>https</code>. You can verify by navigating to your site, being sure to use the <code>http</code> protocol. Do this in a browser, and view the redirect in the network dev tools tab. You can also use <code>cURL</code> with the <code>-L</code> flag to follow redirects and see the redirects listed out listed out.</p><h2 id="the-important-bits">The important bits</h2><p>Most of this is probably self explanatory. The pieces that arenâ€™t as intuitive:</p><ol>
<li>The <strong>Origin request policy</strong> <strong>MUST</strong> forward all headers received to ApiGateway. AWS has a precanned policy called <strong>AllViewer</strong> that does this, but you can also create your own. Just make sure the headers you need are forwarded to ApiGateway by CloudFront</li>
<li>If CORS is disabled for ApiGateway, the custom domain configuration <strong>MUST</strong> exist on both the CloudFront distribution and the ApiGateway. Otherwise, ApiGateway will reject the request.</li>
</ol><p>Hopefully this was helpful!</p>
    </article>  
  </div>
      </main>
    <footer>
  <div class="bg-accent py-4 flex justify-center">
    <div class="text-white">
      <a href="https://github.com/TillaTheHun0/astro-blog">Source Code</a> - Â© Copyright 2022
    </div>
  </div>
</footer>
  </body></html>
